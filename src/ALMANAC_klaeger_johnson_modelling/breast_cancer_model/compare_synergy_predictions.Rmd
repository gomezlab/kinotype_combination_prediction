```{r}
library(tidyverse)
library(here)
library(synergyfinder)
library(patchwork)
```

## Load data

```{r}
prediction_data <- read_csv(here("results/ALMANAC_klaeger_johnson_models/breast_cancer_models/validation/model_predictions_all_kinases_forced_in.csv"))
validation_data <- read_csv(here("results/ALMANAC_klaeger_johnson_models/breast_cancer_models/validation/validation_klaeger_exp_data_for_all_kinases_forced_in.csv"))
```

## Reshape both datasets

```{r}
# Reshape prediction_data
prediction_pair_indicies <- prediction_data %>%
    select(drug1, drug2, cell_line) %>%
    unique() %>%
    mutate(pair_index = 1:n())

prediction_processed <- prediction_data %>%
    left_join(prediction_pair_indicies, by = c("drug1", "drug2", "cell_line")) %>%
    mutate(conc_unit = "M") %>%
    rename(conc1 = nearest_klaeger_dose_1, conc2 = nearest_klaeger_dose_2, response = viability) %>%
    select(pair_index, drug1, drug2, conc1, conc2, conc_unit, response) %>%
    mutate(response = response * 100)

prediction_reshaped <- ReshapeData(
    data = prediction_processed,
    data_type = "viability",
    impute = TRUE,
    impute_method = NULL,
    noise = TRUE,
    seed = 1
)
```

```{r}
# Reshape validation_data
validation_pair_indicies <- validation_data %>%
    select(drug1, drug2, cell_line) %>%
    unique() %>%
    mutate(pair_index = 1:n())

validation_processed <- validation_data %>%
    left_join(validation_pair_indicies, by = c("drug1", "drug2", "cell_line")) %>%
    mutate(conc_unit = "M") %>%
    rename(conc1 = nearest_klaeger_dose_1, conc2 = nearest_klaeger_dose_2, response = viability) %>%
    select(pair_index, drug1, drug2, conc1, conc2, conc_unit, response) %>%
    mutate(response = response * 100)

validation_reshaped <- ReshapeData(
    data = validation_processed,
    data_type = "viability",
    impute = TRUE,
    impute_method = NULL,
    noise = TRUE,
    seed = 1
)
```

## Calculate synergy and sensitivity scores

```{r}
# Calculate synergy and sensitivity scores for prediction_data
prediction_synergy_scores <- CalculateSynergy(
    data = prediction_reshaped,
    method = c("ZIP", "HSA", "Bliss", "Loewe"),
    Emin = NA,
    Emax = NA,
    correct_baseline = "non"
)

prediction_sensitivity_scores <- prediction_synergy_scores %>%
    CalculateSensitivity(correct_baseline = "non")

# Calculate synergy and sensitivity scores for validation_data
validation_synergy_scores <- CalculateSynergy(
    data = validation_reshaped,
    method = c("ZIP", "HSA", "Bliss", "Loewe"),
    Emin = NA,
    Emax = NA,
    correct_baseline = "non"
)

validation_sensitivity_scores <- validation_synergy_scores %>%
    CalculateSensitivity(correct_baseline = "non")
```

```{r}
# Visualize Synergy-Sensitivity Scores
PlotSensitivitySynergy(
    data = prediction_sensitivity_scores,
    plot_synergy = "ZIP",
    show_labels = TRUE,
    dynamic = FALSE
)

PlotSensitivitySynergy(
    data = validation_sensitivity_scores,
    plot_synergy = "ZIP",
    show_labels = TRUE,
    dynamic = FALSE
)
```

```{r}
# Plot Trametinib Omipalisib synergy

Plot2DrugHeatmap(
    data = validation_synergy_scores,
    plot_block = 28,
    drugs = c(1, 2),
    plot_value = "ZIP_synergy",
    dynamic = FALSE,
    summary_statistic = c("quantile_25", "quantile_75")
)

Plot2DrugHeatmap(
    data = prediction_synergy_scores,
    plot_block = 28,
    drugs = c(1, 2),
    plot_value = "ZIP_synergy",
    dynamic = FALSE,
    summary_statistic = c("quantile_25", "quantile_75")
)
```

```{r}
# extract synergy scores for trametinib and omipalisib

prediction_tram_omi_synergy <- prediction_sensitivity_scores$synergy_scores %>%
    filter(block_id == 28)

validation_tram_omi_synergy <- validation_sensitivity_scores$synergy_scores %>%
    filter(block_id == 28)

prediction_tram_omi_sensitivity <- prediction_sensitivity_scores$response %>%
    filter(block_id == 28)

validation_tram_omi_sensitivity <- validation_sensitivity_scores$response %>%
    filter(block_id == 28)
```

```{r}
#Similarly extract synergy scores and sensitivites for all "block_id" present in prediction and validation data

prediction_synergy_scores_all <- prediction_sensitivity_scores$synergy_scores %>%
    write_csv(here('results/ALMANAC_klaeger_johnson_models/breast_cancer_models/prediction_synergy_scores_all.csv'))

prediction_sesnitivity_scores_all <- prediction_sensitivity_scores$response %>%
    write_csv(here('results/ALMANAC_klaeger_johnson_models/breast_cancer_models/prediction_sensitivity_scores_all.csv'))

validation_synergy_scores_all <- validation_sensitivity_scores$synergy_scores %>%
    write_csv(here('results/ALMANAC_klaeger_johnson_models/breast_cancer_models/validation_synergy_scores_all.csv'))

validation_sensitivity_scores_all <- validation_sensitivity_scores$response %>% 
    write_csv(here('results/ALMANAC_klaeger_johnson_models/breast_cancer_models/validation_sensitivity_scores_all.csv'))
```

```{r}    
# Make surface plots
prediction_synergy_plot <- prediction_tram_omi_synergy %>%
    mutate(type = "Predicted Synergy") %>%
    ggplot(aes(factor(conc1), factor(conc2), fill = ZIP_synergy)) +
    geom_tile() +
    scale_fill_viridis_c() +
    labs(
        x = "Trametinib (M)",
        y = "Omipalisib (M)",
        fill = "Synergy\n(ZIP)"
    ) +
    theme(
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        legend.position = "right",
        legend.direction = "vertical",
        legend.margin = margin(t = 0, b = 0, l = 0, r = 0, unit = "cm"),
        panel.background = element_rect(fill = "transparent", colour = NA),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        plot.background = element_rect(fill = "transparent", colour = NA)
    ) +
    facet_wrap(~type)

prediction_sensitivity_plot <- prediction_tram_omi_sensitivity %>%
    mutate(type = "Predicted Sensitivity") %>%
    ggplot(aes(factor(conc1), factor(conc2), fill = response_origin)) +
    geom_tile() +
    scale_fill_viridis_c() +
    labs(
        x = "Trametinib (M)",
        y = "Omipalisib (M)",
        fill = "Sensitivity\n(Viability)"
    ) +
    theme(
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        legend.position = "right",
        legend.direction = "vertical",
        legend.margin = margin(t = 0, b = 0, l = 0, r = 0, unit = "cm"),
        panel.background = element_rect(fill = "transparent", colour = NA),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        plot.background = element_rect(fill = "transparent", colour = NA)
    ) +
    facet_wrap(~type)

prediction_plot <- prediction_synergy_plot / prediction_sensitivity_plot + plot_annotation(title = "Predicted Trametinib + Omipalisib Synergy and Sensitivity")

validation_synergy_plot <- validation_tram_omi_synergy %>%
    mutate(type = "Actual Synergy") %>%
    ggplot(aes(factor(conc1), factor(conc2), fill = ZIP_synergy)) +
    geom_tile() +
    scale_fill_viridis_c() +
    labs(
        x = "Trametinib (M)",
        y = "Omipalisib (M)",
        fill = "Synergy\n(ZIP)"
    ) +
    theme(
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        legend.position = "right",
        legend.direction = "vertical",
        legend.margin = margin(t = 0, b = 0, l = 0, r = 0, unit = "cm"),
        panel.background = element_rect(fill = "transparent", colour = NA),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        plot.background = element_rect(fill = "transparent", colour = NA)
    ) +
    facet_wrap(~type)

validation_sensitivity_plot <- validation_tram_omi_sensitivity %>%
    mutate(type = "Actual Sensitivity") %>%
    ggplot(aes(factor(conc1), factor(conc2), fill = response_origin)) +
    geom_tile() +
    scale_fill_viridis_c() +
    labs(
        x = "Trametinib (M)",
        y = "Omipalisib (M)",
        fill = "Sensitivity\n(Viability)"
    ) +
    theme(
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        legend.position = "right",
        legend.direction = "vertical",
        legend.margin = margin(t = 0, b = 0, l = 0, r = 0, unit = "cm"),
        panel.background = element_rect(fill = "transparent", colour = NA),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        plot.background = element_rect(fill = "transparent", colour = NA)
    ) +
    facet_wrap(~type)

validation_plot <- validation_synergy_plot / validation_sensitivity_plot + plot_annotation(title = "Actual Trametinib + Omipalisib Synergy and Sensitivity")

full_plot <- prediction_plot | validation_plot
ggsave(here("figures/ALMANAC_klaeger_johnson/tram_omi_predicted_synergy_sensitivity.png"), width = 6, height = 4, units = "in")
```